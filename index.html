<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Macca Stock v19.11.3</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'macca-dark': '#0a0a0c',
                        'macca-card': 'rgba(22, 22, 26, 0.8)',
                        'macca-yellow': '#fbbf24',
                        'macca-gold': '#d4af37',
                        'macca-green': '#22c55e',
                        'macca-blue': '#3b82f6',
                        'macca-red': '#ef4444',
                        'macca-purple': '#a855f7',
                        'macca-cyan': '#06b6d4',
                        'macca-orange': '#f97316',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0a0a0c; color: white; font-family: 'Plus Jakarta Sans', sans-serif; background-image: radial-gradient(circle at top right, rgba(212, 175, 55, 0.05), transparent); }
        .glass { background: rgba(22, 22, 26, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-item.active { color: #fbbf24; text-shadow: 0 0 10px rgba(251, 191, 36, 0.4); }
        .fab-right { position: fixed; bottom: 100px; right: 20px; z-index: 50; display: flex; flex-direction: column; align-items: center; gap: 12px; }
        .fab-sub { width: 60px; height: 60px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: scale(0); opacity: 0; pointer-events: none; }
        .fab-main { width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, #fbbf24, #d4af37); color: #000; display: flex; align-items: center; justify-content: center; font-size: 28px; }
        .fab-quick { width: 70px; height: 70px; border-radius: 50%; background: #ef4444; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .fab-right.active .fab-sub { transform: scale(1); opacity: 1; pointer-events: auto; }
        #qty, #edit-qty-input { font-size: 80px !important; color: #fbbf24; text-shadow: 0 0 20px rgba(251, 191, 36, 0.2); }
        #welcome-toast.show { display: flex; animation: slideDown 0.5s forwards; }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
        .btn-sel-active { border-color: #fbbf24 !important; color: #fbbf24 !important; transform: scale(1.05); }
        .btn-sel-inactive { border-color: rgba(255,255,255,0.05) !important; color: #64748b !important; }
    </style>
</head>
<body class="antialiased pb-24">

    <div id="welcome-toast" class="hidden fixed top-6 left-4 right-4 z-[200] bg-macca-yellow rounded-3xl p-4 shadow-2xl items-center gap-4 border-2 border-white/20">
        <div class="w-12 h-12 bg-black rounded-2xl flex items-center justify-center text-macca-yellow text-xl"><i class="fas fa-hand-sparkles"></i></div>
        <div>
            <p class="text-[10px] font-black text-black/60 uppercase tracking-widest">Selamat Bekerja,</p>
            <h4 id="toast-user-name" class="text-lg font-black text-black leading-tight uppercase">USER</h4>
        </div>
    </div>

    <div id="section-login" class="fixed inset-0 z-[100] bg-macca-dark flex flex-col items-center justify-center px-8 text-center">
        <h1 class="text-5xl font-black text-macca-yellow italic mb-1 uppercase tracking-tighter">MACCA<span class="text-white">.v19</span></h1>
        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.3em] mb-10">Inventory Management</p>
        <div class="w-full max-w-xs space-y-5">
            <input type="password" id="login-code" inputmode="numeric" placeholder="KODE" class="glass w-full p-5 rounded-3xl text-center text-4xl font-black text-macca-yellow outline-none border-2 border-white/5 focus:border-macca-yellow/30 transition-all">
            <button onclick="handleLogin()" class="w-full bg-gradient-to-r from-macca-yellow to-macca-gold text-black font-black py-6 rounded-3xl uppercase shadow-lg shadow-macca-yellow/20 hover:scale-[1.02] active:scale-95 transition-all"><i class="fas fa-sign-in-alt mr-2"></i> MASUK</button>
        </div>
    </div>

    <div id="section-app" class="hidden">
        <nav class="px-6 py-5 flex justify-between items-center bg-macca-dark/80 backdrop-blur-md sticky top-0 z-40 border-b border-white/5">
            <div>
                <h1 class="text-xl font-black italic text-macca-yellow uppercase">Macca Stock</h1>
                <p id="display-user-name" class="text-[10px] text-macca-green font-bold uppercase"></p>
            </div>
            <button onclick="location.reload()" class="w-10 h-10 glass rounded-xl flex items-center justify-center text-macca-red"><i class="fas fa-power-off"></i></button>
        </nav>

        <main class="max-w-md mx-auto p-4">
            <div id="tab-home" class="tab-content active space-y-6">
                <section class="glass rounded-[2.5rem] p-6 shadow-xl text-center">
                    <p class="text-[10px] font-bold text-macca-green uppercase tracking-widest mb-1">Omzet Tunai Hari Ini</p>
                    <h2 id="total-omzet" class="text-4xl font-black text-white mb-5">Rp 0</h2>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="bg-black/30 p-3 rounded-2xl border border-white/5 text-left">
                            <p class="text-[8px] text-slate-500 uppercase font-bold mb-1">Ayam/Crispy</p>
                            <h2 id="count-ayam-sales" class="text-lg font-black text-macca-yellow">0</h2>
                            <p id="omzet-ayam" class="text-[8px] text-slate-400">Rp 0</p>
                        </div>
                        <div class="bg-black/30 p-3 rounded-2xl border border-white/5 text-left">
                            <p class="text-[8px] text-slate-500 uppercase font-bold mb-1">I.Bandeng</p>
                            <h2 id="count-ikan-sales" class="text-lg font-black text-macca-blue">0</h2>
                            <p id="omzet-ikan" class="text-[8px] text-slate-400">Rp 0</p>
                        </div>
                        <div class="bg-black/30 p-3 rounded-2xl border border-white/5 text-left">
                            <p class="text-[8px] text-slate-500 uppercase font-bold mb-1">I.Laut</p>
                            <h2 id="count-ikanlaut-sales" class="text-lg font-black text-macca-cyan">0</h2>
                            <p id="omzet-ikanlaut" class="text-[8px] text-slate-400">Rp 0</p>
                        </div>
                    </div>
                </section>

                <div class="grid grid-cols-2 gap-4">
                    <div class="glass p-5 rounded-[2rem] text-center"><p class="text-[10px] font-extrabold text-slate-500 uppercase mb-2">Mentah</p><p id="stat-mentah-main" class="text-3xl font-black text-slate-300">0</p></div>
                    <div class="glass p-5 rounded-[2rem] text-center"><p class="text-[10px] font-extrabold text-slate-500 uppercase mb-2">Ungkep</p><p id="stat-ungkep-main" class="text-3xl font-black text-macca-yellow">0</p></div>
                    <div class="glass p-5 rounded-[2rem] text-center col-span-2 border-macca-orange/20"><p class="text-[10px] font-extrabold text-macca-orange uppercase mb-1">Crispy</p><p id="stat-crispy-main" class="text-4xl font-black text-white">0</p></div>
                    <div class="glass p-5 rounded-[2rem] text-center"><p class="text-[10px] font-extrabold text-slate-500 uppercase mb-2">Bandeng</p><p id="stat-ikan-main" class="text-3xl font-black text-macca-green">0</p></div>
                    <div class="glass p-5 rounded-[2rem] text-center"><p class="text-[10px] font-extrabold text-slate-500 uppercase mb-2">I.Laut</p><p id="stat-ikanlaut-main" class="text-3xl font-black text-macca-cyan">0</p></div>
                </div>
            </div>

            <div id="tab-history" class="tab-content space-y-4">
                <div class="flex items-center justify-between px-2">
                    <h3 class="text-xs font-black text-white uppercase italic tracking-widest"><i class="fas fa-history mr-2 text-macca-yellow"></i>Riwayat</h3>
                    <input type="date" id="filter-history-tgl" class="glass rounded-xl text-[10px] p-2 outline-none text-macca-yellow border-macca-yellow/20">
                </div>
                <div id="history-list" class="space-y-3"></div>
            </div>

            <div id="tab-rekap" class="tab-content space-y-6">
                <section class="space-y-3">
                    <div class="flex items-center justify-between px-2">
                        <h3 class="text-xs font-black text-white uppercase italic tracking-widest">Rekap Harian</h3>
                        <input type="date" id="filter-tanggal" class="glass rounded-lg text-[10px] p-2 outline-none text-macca-yellow">
                    </div>
                    <div class="glass rounded-3xl p-5 overflow-hidden"><table class="w-full text-[11px]"><tbody id="rekap-harian-body"></tbody></table></div>
                </section>
                <section class="space-y-3">
                    <div class="flex items-center justify-between px-2">
                        <h3 class="text-xs font-black text-white uppercase italic tracking-widest">Rekap Bulanan</h3>
                        <input type="month" id="filter-bulan" class="glass rounded-lg text-[10px] p-2 outline-none text-macca-yellow">
                    </div>
                    <div class="glass rounded-3xl p-5 shadow-xl">
                        <table class="w-full text-left text-[11px]">
                            <thead><tr class="text-slate-500 border-b border-white/5 font-bold uppercase"><th class="py-3">Kategori</th><th class="py-3 text-right">Qty</th><th class="py-3 text-right">Total</th></tr></thead>
                            <tbody id="rekap-table-body"></tbody>
                            <tfoot><tr class="text-white border-t border-white/10"><th class="py-4 font-black uppercase">TOTAL</th><th id="rekap-total-qty" class="py-4 text-right font-black">-</th><th id="rekap-grand-total" class="py-4 text-right font-black text-macca-green">-</th></tr></tfoot>
                        </table>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <div id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-macca-dark/90 backdrop-blur-xl border-t border-white/10 px-8 py-4 flex justify-between items-center z-50 hidden">
        <button onclick="switchTab('home')" class="nav-item active flex flex-col items-center gap-1"><i class="fas fa-home text-xl"></i><span class="text-[9px] font-bold uppercase">Beranda</span></button>
        <button onclick="switchTab('history')" class="nav-item flex flex-col items-center gap-1"><i class="fas fa-history text-xl"></i><span class="text-[9px] font-bold uppercase">Riwayat</span></button>
        <button onclick="switchTab('rekap')" class="nav-item flex flex-col items-center gap-1"><i class="fas fa-chart-pie text-xl"></i><span class="text-[9px] font-bold uppercase">Rekap</span></button>
    </div>

    <div id="fab-container-right" class="fab-right hidden">
        <div onclick="openInput('Crispy')" class="fab-sub glass border-2 border-macca-orange"><span class="text-[9px] font-black text-macca-orange">CRISPY</span></div>
        <div onclick="openInput('Ungkep')" class="fab-sub glass border-2 border-macca-yellow"><span class="text-[9px] font-black text-macca-yellow">UNGKEP</span></div>
        <div onclick="openInput('Ikan')" class="fab-sub glass border-2 border-macca-green"><span class="text-[9px] font-black text-macca-green">BANDENG</span></div>
        <div onclick="openInput('IkanLaut')" class="fab-sub glass border-2 border-macca-cyan"><span class="text-[9px] font-black text-macca-cyan">I.LAUT</span></div>
        <div onclick="openInput('Mentah')" class="fab-sub glass border-2 border-macca-blue"><span class="text-[9px] font-black text-macca-blue">MENTAH</span></div>
        <button id="main-fab-btn" onclick="toggleFab()" class="fab-main"><i class="fas fa-plus"></i></button>
        <button id="quick-fab-btn" onclick="openQuickSale()" class="fab-quick hidden transition-transform active:scale-90 shadow-lg shadow-red-500/20"><i class="fas fa-cash-register text-2xl mb-1"></i><span class="text-[8px] font-black uppercase">JUAL</span></button>
    </div>

    <div id="modal-input" class="fixed inset-0 z-[80] bg-black/95 hidden flex items-end justify-center">
        <div class="glass w-full max-w-md rounded-t-[3.5rem] p-7 pb-10 shadow-2xl transition-all">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-black uppercase italic text-macca-yellow" id="modal-title">QTY</h2>
                <div id="price-tag"><p id="display-price" class="text-xl font-black text-macca-green">Rp 0</p></div>
            </div>
            <div id="item-selector" class="flex gap-2 mb-6 hidden overflow-x-auto pb-2">
                <button onclick="selectItem('Ungkep')" id="sel-ungkep" class="whitespace-nowrap px-6 py-4 rounded-2xl font-black text-xs border-2 transition-all">AYAM</button>
                <button onclick="selectItem('Crispy')" id="sel-crispy" class="whitespace-nowrap px-6 py-4 rounded-2xl font-black text-xs border-2 transition-all">CRISPY</button>
                <button onclick="selectItem('Ikan')" id="sel-ikan" class="whitespace-nowrap px-6 py-4 rounded-2xl font-black text-xs border-2 transition-all">BANDENG</button>
                <button onclick="selectItem('IkanLaut')" id="sel-ikanlaut" class="whitespace-nowrap px-6 py-4 rounded-2xl font-black text-xs border-2 transition-all">I.LAUT</button>
            </div>
            <input type="number" id="qty" placeholder="0" class="w-full text-center font-black bg-transparent outline-none mb-6 text-macca-yellow">
            <div id="note-section"><select id="note" onchange="updatePriceDisplay()" class="w-full p-5 bg-black/50 rounded-2xl font-black text-center mb-8 text-white uppercase border border-white/10 outline-none"></select></div>
            <div class="flex flex-col gap-3">
                <div class="flex gap-3">
                    <button onclick="closeInput()" class="flex-1 py-6 rounded-3xl font-black text-slate-500 uppercase transition-all">Batal</button>
                    <button id="btn-save-cash" onclick="saveData('CASH')" class="flex-[2] bg-gradient-to-r from-macca-green to-green-600 text-black font-black py-6 rounded-3xl uppercase shadow-lg shadow-green-500/20 transition-all active:scale-95"><i class="fas fa-save mr-2"></i> SIMPAN</button>
                </div>
                <button id="btn-save-qris" onclick="saveData('QRIS')" class="hidden w-full bg-macca-purple text-white font-black py-6 rounded-3xl uppercase shadow-lg shadow-purple-500/20 transition-all active:scale-95"><i class="fas fa-qrcode mr-2"></i> SIMPAN (QRIS)</button>
            </div>
        </div>
    </div>

    <div id="modal-edit" class="fixed inset-0 z-[90] bg-black/95 hidden flex items-end justify-center">
        <div class="glass w-full max-w-md rounded-t-[3.5rem] p-7 pb-10 shadow-2xl transition-all">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-black uppercase italic text-macca-blue">EDIT QTY</h2>
                <p id="edit-item-name" class="text-xs font-bold text-slate-500 uppercase"></p>
            </div>
            <input type="number" id="edit-qty-input" placeholder="0" class="w-full text-center font-black bg-transparent outline-none mb-8 text-macca-blue">
            <div class="flex gap-3">
                <button onclick="closeEditModal()" class="flex-1 py-6 rounded-3xl font-black text-slate-500 uppercase transition-all">Batal</button>
                <button id="btn-update-data" class="flex-[2] bg-gradient-to-r from-macca-blue to-blue-700 text-white font-black py-6 rounded-3xl uppercase shadow-lg shadow-blue-500/20 transition-all active:scale-95"><i class="fas fa-check mr-2"></i> UPDATE</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, serverTimestamp, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCCmKgOnBFpluEKuycYjrBRm4zbxrHI1P8",
            authDomain: "stocklistmacca.firebaseapp.com",
            databaseURL: "https://stocklistmacca-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "stocklistmacca",
            storageBucket: "stocklistmacca.firebasestorage.app",
            messagingSenderId: "277279553860",
            appId: "1:277279553860:web:22eb68808ed307ea76bf11"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, 'stok_macca_v14_flow');

        const PRICES = { "Ungkep": 14000, "Crispy": 12000, "Ikan": 13000, "IkanLaut": 13000, "Mentah": 0 };
        const USERS = {
            "1": { name: "Ibu Ati", type: "admin" },
            "2": { name: "Nita (Asisten)", type: "admin" },
            "3": { name: "Ara", type: "staff", id: "3" },
            "4": { name: "Dilla", type: "staff", id: "4" },
            "5": { name: "Rezky", type: "staff", id: "5" },
            "6": { name: "Sendy", type: "staff", id: "6" }
        };

        let activeUser = null, dataRaw = {}, currentTabItem = 'Ungkep', currentMode = '';

        window.handleLogin = () => {
            const val = document.getElementById('login-code').value;
            if (USERS[val]) { 
                activeUser = USERS[val]; 
                document.getElementById('section-login').classList.add('hidden');
                document.getElementById('section-app').classList.remove('hidden');
                document.getElementById('bottom-nav').classList.remove('hidden');
                document.getElementById('display-user-name').innerText = activeUser.name;
                document.getElementById('fab-container-right').classList.remove('hidden');
                
                const toast = document.getElementById('welcome-toast');
                document.getElementById('toast-user-name').innerText = activeUser.name;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);

                const today = new Date();
                const todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
                const monthStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');

                document.getElementById('filter-tanggal').value = todayStr;
                document.getElementById('filter-history-tgl').value = todayStr;
                document.getElementById('filter-bulan').value = monthStr;

                if(activeUser.type === "admin") {
                    document.getElementById('main-fab-btn').classList.remove('hidden');
                    document.getElementById('quick-fab-btn').classList.add('hidden');
                } else {
                    document.getElementById('main-fab-btn').classList.add('hidden');
                    document.getElementById('quick-fab-btn').classList.remove('hidden');
                }
                onValue(dbRef, (snap) => { dataRaw = snap.val() || {}; render(); });
            } else { alert("KODE SALAH!"); }
        };

        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        };

        window.toggleFab = () => document.getElementById('fab-container-right').classList.toggle('active');

        // MODAL EDIT HANDLER
        window.openEditModal = (key, currentQty, itemName) => {
            if (activeUser?.id === "3") {
                document.getElementById('modal-edit').classList.remove('hidden');
                document.getElementById('edit-qty-input').value = currentQty;
                document.getElementById('edit-item-name').innerText = itemName;
                document.getElementById('btn-update-data').onclick = () => {
                    const newQty = parseInt(document.getElementById('edit-qty-input').value);
                    if (!isNaN(newQty)) {
                        update(ref(db, `stok_macca_v14_flow/${key}`), { qty: newQty })
                        .then(() => {
                            closeEditModal();
                            alert("Berhasil diperbarui!");
                        }).catch(e => alert(e.message));
                    }
                };
            }
        };

        window.closeEditModal = () => {
            document.getElementById('modal-edit').classList.add('hidden');
        };

        window.deleteData = (key) => {
            if (activeUser?.id === "3" && confirm("Hapus data ini?")) {
                remove(ref(db, `stok_macca_v14_flow/${key}`)).catch(e => alert(e.message));
            }
        };

        window.updateNoteOptions = () => {
            const sel = document.getElementById('note');
            sel.innerHTML = ``;
            let options = [];
            if (["5","6"].includes(activeUser.id)) {
                options = ["Penj. Gerai Depan"];
            } else if (["3","4"].includes(activeUser.id)) {
                if (currentTabItem === 'Ungkep' || currentTabItem === 'Crispy') {
                    options = ["Penj. Kasir", "Penj. Grab", "Ayam Nasi Goreng", "Ayam Suir", "Ayam Karyawan", "Ayam Rusak"];
                } else {
                    options = ["Penj. Kasir", "Penj. Grab", "Karyawan", "Rusak"];
                }
            } else {
                options = ["Penj. Kasir", "Penj. Grab", "Penj. Gerai Depan"];
            }
            options.forEach(n => { sel.innerHTML += `<option value="${n}">${n}</option>`; });
            if (options.length > 0) sel.value = options[0];
        };

        window.selectItem = (t) => {
            currentTabItem = t;
            updateNoteOptions();
            updatePriceDisplay();
            ['ungkep', 'crispy', 'ikan', 'ikanlaut'].forEach(id => {
                const btn = document.getElementById('sel-' + id);
                if (btn) {
                    if (t.toLowerCase() === id) {
                        btn.classList.remove('btn-sel-inactive');
                        btn.classList.add('btn-sel-active');
                    } else {
                        btn.classList.remove('btn-sel-active');
                        btn.classList.add('btn-sel-inactive');
                    }
                }
            });
        };

        window.updatePriceDisplay = () => {
            const noteVal = document.getElementById('note').value.toLowerCase();
            const freeItems = ['nasi goreng', 'suir', 'karyawan', 'rusak'];
            const isFree = freeItems.some(item => noteVal.includes(item));
            document.getElementById('display-price').innerText = isFree ? "Rp 0" : "Rp " + (PRICES[currentTabItem] || 0).toLocaleString();
        };

        window.openQuickSale = () => {
            document.getElementById('item-selector').classList.remove('hidden');
            document.getElementById('btn-save-qris').classList.remove('hidden');
            document.getElementById('btn-save-cash').innerText = 'SIMPAN (CASH)';
            document.getElementById('note-section').classList.remove('hidden');
            currentMode = 'Keluar';
            selectItem('Ungkep');
            document.getElementById('modal-title').innerText = 'JUAL';
            document.getElementById('modal-input').classList.remove('hidden');
        };

        window.openInput = (t) => {
            currentTabItem = t;
            document.getElementById('modal-title').innerText = t === 'Ungkep' ? 'AYAM' : t.toUpperCase();
            document.getElementById('modal-input').classList.remove('hidden');
            document.getElementById('item-selector').classList.add('hidden');
            document.getElementById('btn-save-qris').classList.add('hidden');
            document.getElementById('btn-save-cash').innerText = 'SIMPAN';
            document.getElementById('note-section').classList.add('hidden');
            currentMode = (t === 'Ungkep' || t === 'Crispy') ? `Tambah ${t}` : 'Masuk';
            updatePriceDisplay();
        };

        window.closeInput = () => { document.getElementById('modal-input').classList.add('hidden'); document.getElementById('qty').value = ''; };

        window.saveData = (metode = 'CASH') => {
            const valQty = parseInt(document.getElementById('qty').value);
            if(!valQty) return alert("Isi Jumlah!");
            const selNode = document.getElementById('note');
            let noteStr = (activeUser.type === 'admin' && currentMode !== 'Keluar') ? ("TAMBAH STOK " + (currentTabItem === 'Ungkep' ? 'UNGKEP' : currentTabItem.toUpperCase())) : selNode.value;
            if(!noteStr && currentMode === 'Keluar') return alert("Pilih Tujuan!");
            let price = 0;
            const noteLower = noteStr.toLowerCase();
            const freeKeywords = ['nasi goreng', 'suir', 'karyawan', 'rusak'];
            const isFree = freeKeywords.some(k => noteLower.includes(k));
            if (!isFree) {
                if (noteLower.includes('penj') || noteLower.includes('kasir') || noteLower.includes('grab') || noteLower.includes('gerai')) {
                    price = PRICES[currentTabItem];
                }
            }
            let finalNote = noteStr;
            if(metode === 'QRIS' && price > 0) finalNote += " (QRIS)";
            if (activeUser.type === 'admin' && currentTabItem === 'Ungkep' && currentMode === 'Tambah Ungkep') {
                push(dbRef, { user: activeUser.name, type: 'Ungkep', qty: valQty, status: 'Masuk', note: finalNote, price: 0, time: serverTimestamp() });
                push(dbRef, { user: activeUser.name, type: 'Mentah', qty: valQty, status: 'Keluar', note: 'PROSES UNGKEP (AUTO)', price: 0, time: serverTimestamp() });
            } else {
                push(dbRef, { user: activeUser.name, type: currentTabItem, qty: valQty, status: currentMode === 'Keluar' ? 'Keluar' : 'Masuk', note: finalNote, price: price, time: serverTimestamp() });
            }
            closeInput();
        };

        document.getElementById('filter-tanggal').addEventListener('change', () => render());
        document.getElementById('filter-bulan').addEventListener('change', () => render());
        document.getElementById('filter-history-tgl').addEventListener('change', () => render());

        function render() {
            let sM = 0, sU = 0, sC = 0, sI = 0, sIL = 0; 
            let omzHarianTunai = 0, aQtyTunai = 0, iQtyTunai = 0, ilQtyTunai = 0, aOmzTunai = 0, iOmzTunai = 0, ilOmzTunai = 0;
            let rekapHarian = {}; let rekapBulanan = {}; let rGrandQ = 0; let rGrandT = 0;
            
            const now = new Date();
            const startToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            
            const filterTgl = document.getElementById('filter-tanggal').value;
            const filterBln = document.getElementById('filter-bulan').value;
            const filterHist = document.getElementById('filter-history-tgl').value;
            const hl = document.getElementById('history-list'); hl.innerHTML = '';

            const keys = Object.keys(dataRaw);
            const sortedKeys = keys.sort((a, b) => (dataRaw[a].time || 0) - (dataRaw[b].time || 0));

            sortedKeys.forEach(keyId => {
                const i = dataRaw[keyId];
                const add = (i.status === 'Masuk') ? i.qty : -i.qty;
                if(i.type === 'Mentah') sM += add;
                else if(i.type === 'Ungkep') sU += add;
                else if(i.type === 'Crispy') sC += add;
                else if(i.type === 'Ikan') sI += add;
                else if(i.type === 'IkanLaut') sIL += add;

                const dt = new Date(i.time);
                const isSale = i.price > 0;
                const isQRIS = i.note.includes("(QRIS)");
                const itemTgl = dt.getFullYear() + '-' + String(dt.getMonth() + 1).padStart(2, '0') + '-' + String(dt.getDate()).padStart(2, '0');
                const itemBulan = dt.getFullYear() + '-' + String(dt.getMonth() + 1).padStart(2, '0');

                if(i.time >= startToday && isSale && !isQRIS) {
                    const lineTotal = i.qty * i.price;
                    omzHarianTunai += lineTotal;
                    if(i.type === 'Ungkep' || i.type === 'Crispy') { aQtyTunai += i.qty; aOmzTunai += lineTotal; } 
                    else if(i.type === 'Ikan') { iQtyTunai += i.qty; iOmzTunai += lineTotal; }
                    else if(i.type === 'IkanLaut') { ilQtyTunai += i.qty; ilOmzTunai += lineTotal; }
                }

                let displayType = i.type.toUpperCase();
                if (i.type === 'Ungkep') displayType = (i.status === 'Keluar') ? 'AYAM' : 'UNGKEP';
                const keyRekap = `${displayType} - ${i.note}`;

                if(itemTgl === filterTgl && (isSale || i.status === 'Keluar' || i.status === 'Masuk')) {
                    if(!rekapHarian[keyRekap]) rekapHarian[keyRekap] = { qty: 0, total: 0 };
                    rekapHarian[keyRekap].qty += i.qty;
                    rekapHarian[keyRekap].total += (i.qty * i.price);
                }

                if(itemBulan === filterBln && (isSale || i.status === 'Keluar')) {
                    if(!rekapBulanan[keyRekap]) rekapBulanan[keyRekap] = { qty: 0, total: 0 };
                    rekapBulanan[keyRekap].qty += i.qty;
                    rekapBulanan[keyRekap].total += (i.qty * i.price);
                    rGrandQ += i.qty; rGrandT += (i.qty * i.price);
                }

                if(itemTgl === filterHist) {
                    const tm = String(dt.getHours()).padStart(2,'0') + ':' + String(dt.getMinutes()).padStart(2,'0');
                    const icon = i.status === 'Masuk' ? 'fa-arrow-down text-macca-green' : (isSale ? (isQRIS ? 'fa-qrcode text-macca-purple' : 'fa-tag text-macca-yellow') : 'fa-arrow-up text-macca-red');
                    
                    let actionBtns = '';
                    if (activeUser?.id === "3") {
                        actionBtns = `
                            <div class="flex items-center gap-1 ml-2">
                                <button onclick="openEditModal('${keyId}', ${i.qty}, '${displayType}')" class="w-8 h-8 rounded-lg bg-macca-blue/20 text-macca-blue flex items-center justify-center active:scale-90 transition-all"><i class="fas fa-edit text-xs"></i></button>
                                <button onclick="deleteData('${keyId}')" class="w-8 h-8 rounded-lg bg-macca-red/20 text-macca-red flex items-center justify-center active:scale-90 transition-all"><i class="fas fa-trash-alt text-xs"></i></button>
                            </div>`;
                    }

                    hl.innerHTML = `
                    <div class="glass p-4 rounded-3xl border border-white/5 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-sm"><i class="fas ${icon}"></i></div>
                            <div>
                                <h4 class="font-black text-[10px] text-white uppercase">${i.note} <span class="text-slate-600 ml-1">#${tm}</span></h4>
                                <p class="text-[9px] text-slate-500 font-bold uppercase">${i.user} â€¢ ${displayType}</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <div class="text-right">
                                <p class="text-lg font-black ${i.status === 'Masuk' ? 'text-macca-green' : 'text-white'}">${i.status === 'Masuk' ? '+' : '-'}${i.qty}</p>
                                <p class="text-[9px] font-bold ${isQRIS ? 'text-macca-purple' : 'text-macca-green'}">${i.price > 0 ? 'Rp '+(i.qty*i.price).toLocaleString() : 'Rp 0'}</p>
                            </div>
                            ${actionBtns}
                        </div>
                    </div>` + hl.innerHTML;
                }
            });

            document.getElementById('stat-mentah-main').innerText = sM;
            document.getElementById('stat-ungkep-main').innerText = sU;
            document.getElementById('stat-crispy-main').innerText = sC;
            document.getElementById('stat-ikan-main').innerText = sI;
            document.getElementById('stat-ikanlaut-main').innerText = sIL;
            document.getElementById('total-omzet').innerText = "Rp " + omzHarianTunai.toLocaleString();
            document.getElementById('count-ayam-sales').innerText = aQtyTunai;
            document.getElementById('count-ikan-sales').innerText = iQtyTunai;
            document.getElementById('count-ikanlaut-sales').innerText = ilQtyTunai;
            document.getElementById('omzet-ayam').innerText = "Rp " + aOmzTunai.toLocaleString();
            document.getElementById('omzet-ikan').innerText = "Rp " + iOmzTunai.toLocaleString();
            document.getElementById('omzet-ikanlaut').innerText = "Rp " + ilOmzTunai.toLocaleString();

            const rh = document.getElementById('rekap-harian-body'); rh.innerHTML = '';
            Object.keys(rekapHarian).sort().forEach(k => {
                const color = k.includes('QRIS') ? 'text-macca-purple' : (rekapHarian[k].total > 0 ? 'text-macca-yellow' : 'text-slate-500');
                rh.innerHTML += `<tr class="border-b border-white/5"><td class="py-3 text-slate-300 font-bold uppercase">${k}</td><td class="py-3 text-right font-black text-white">${rekapHarian[k].qty}</td><td class="py-3 text-right font-black ${color}">Rp ${rekapHarian[k].total.toLocaleString()}</td></tr>`;
            });

            const rb = document.getElementById('rekap-table-body'); rb.innerHTML = '';
            Object.keys(rekapBulanan).sort().forEach(k => {
                const color = k.includes('QRIS') ? 'text-macca-purple' : (rekapBulanan[k].total > 0 ? 'text-macca-yellow' : 'text-slate-500');
                rb.innerHTML += `<tr class="border-b border-white/5"><td class="py-3 text-slate-300 font-bold uppercase">${k}</td><td class="py-3 text-right font-black text-white">${rekapBulanan[k].qty}</td><td class="py-3 text-right font-black ${color}">Rp ${rekapBulanan[k].total.toLocaleString()}</td></tr>`;
            });
            document.getElementById('rekap-total-qty').innerText = rGrandQ;
            document.getElementById('rekap-grand-total').innerText = "Rp " + rGrandT.toLocaleString();
        }
    </script>
</body>
</html>
